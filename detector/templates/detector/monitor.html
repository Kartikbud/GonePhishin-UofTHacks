{% extends 'detector/base.html' %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>

<div class="min-h-screen bg-gray-100 flex flex-col">
    <div class="p-4">
        <h1 class="text-3xl font-bold text-gray-800 text-center">
            Scam Call Detector
        </h1>
        <p class="text-gray-600 text-center mt-2">
            Put your call on speaker and start monitoring
        </p>
    </div>

    <div class="text-center mb-4">
        <span id="status" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-300 text-gray-900">
            Ready to monitor
        </span>
    </div>

    <div class="bg-black rounded-lg mx-6 shadow-lg p-4 overflow-y-auto" style="height: 350px;">
        <div id="console" class="font-mono text-sm text-green-500">
            <div class="opacity-70">$ System initialized...</div>
            <div class="opacity-70">$ Ready to monitor. Click Start to begin...</div>
        </div>
    </div>

    <div class="mt-8 mb-4">
        <div class="flex justify-center items-center gap-6">
            <!-- Start Button -->
            <button id="startBtn"
                class="w-24 h-10 rounded-md bg-green-500 hover:bg-green-600 text-white text-sm font-bold flex items-center justify-center shadow-lg focus:outline-none">
                Start
            </button>

            <button id="muteBtn"
                class="w-24 h-10 rounded-md bg-orange-500 hover:bg-orange-600 text-white text-sm font-bold flex items-center justify-center shadow-lg focus:outline-none">
                Mute
            </button>

            <button id="stopBtn"
                class="w-24 h-10 rounded-md bg-red-500 hover:bg-red-600 text-white text-sm font-bold flex items-center justify-center shadow-lg focus:outline-none">
                Stop
            </button>
        </div>
    </div>
</div>

<style>
    #console {
        overflow-y: auto;
        height: 100%;
    }

    #console .success {
        color: #10B981;
    }

    #console .error {
        color: #EF4444;
    }

    #console .warning {
        color: #F59E0B;
    }
</style>

<script>
    const socket = new WebSocket(
        'ws://' + window.location.host + '/ws/'
    );

    function setupSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.lang = "en-US";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    let isRunning = false;

    recognition.onresult = (event) => {
      const transcript = event.results[event.results.length - 1][0].transcript;
      console.log(transcript); // Show transcribed speech in console
    };

    document.body.onclick = () => {
      if (isRunning === false) {
        recognition.start();
        console.log("Listening...");
        isRunning = true;
      } else {
        recognition.stop();
        console.log("Speech recognition has stopped.");
        isRunning = false;
      }
    };
}
setupSpeechRecognition();
    function appendToConsole(message, className = '') {
        const consoleDiv = document.getElementById('console');
        const messageDiv = document.createElement('div');
        messageDiv.className = className;
        messageDiv.textContent = message;
        consoleDiv.appendChild(messageDiv);

        // consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    socket.onopen = function (e) {
        appendToConsole("Connection established", 'success');
    };

    socket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        appendToConsole(data.message);
    };

    socket.onerror = function (e) {
        appendToConsole("Connection error", 'error');
    };

    socket.onclose = function (e) {
        appendToConsole("Connection closed", 'warning');
    };

    document.getElementById('startBtn').addEventListener('click', function () {
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ 'command': 'start' }));
            appendToConsole('Starting monitoring...', 'success');
        } else {
            appendToConsole('Error: WebSocket not connected', 'error');
        }
    });

    document.getElementById('stopBtn').addEventListener('click', function () {
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ 'command': 'stop' }));
            // this.disabled = true;
            // document.getElementById('startBtn').disabled = false;
            appendToConsole('Stopping monitoring...', 'warning');
        } else {
            appendToConsole('Error: WebSocket not connected', 'error');
        }
    });

    document.getElementById('muteBtn').addEventListener('click', function () {
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ 'command': 'mute' }));
            appendToConsole('Toggled mute...', 'warning');
        } else {
            appendToConsole('Error: WebSocket not connected', 'error');
        }
    });

</script>
{% endblock %}